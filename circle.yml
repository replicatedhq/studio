machine:
  pre:
    - mkdir ~/.cache/yarn
  node:
    version: 8

dependencies:
  override:
    - yarn
    - docker build -t replicatedhq/replicated-studio:$(node -e "console.log(require('./package.json').version);") .
  cache_directories:
    - ~/.cache/yarn

test:
  override:
    - yarn test

deployment:
  npm:
    branch: master
    owner: replicatedhq
    commands:
      - echo "//registry.npmjs.org/:_authToken=${NPM_AUTH_TOKEN}" > ~/.npmrc
      - yarn run publish-if-version-changed
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag replicatedhq/replicated-studio:$(node -e "console.log(require('./package.json').version);") replicatedhq/replicated-studio:latest
      - docker push replicatedhq/replicated-studio:$(node -e "console.log(require('./package.json').version);")
      - docker push replicatedhq/replicated-studio:latest